---
title: "Orange County Private School Enrollment, 2016-17"
author: "Hannah Fresques"
date: "3/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(here)
library(readxl)
library(readr)
library(stringr)
library(tidyr)
library(ggplot2)

# turn off scientific notation
options(scipen=999)
```

THIS IS VERSION HAS WORKED EXAMPLES.
DURING CLASS, PLEASE USE THE OTHER VERSION.


# About the data

Data on school enrollment is available from the California Department of Education. Several files were downloaded and saved in the data subfolder.
  - Private school enrollment data: https://www.cde.ca.gov/ds/si/ps/ 
  - Public school enrollment data: https://www.cde.ca.gov/ds/sd/sd/filesenr.asp 

# Background & Questions

I'm interested to know which school districts in Orange County have the most students in private school. Let's find out!

# Read in and explore private school data

This data is in an Excel file. We can use the read_xls function from the readxl package to read in the data.  

```{r}
priv <- here("privateSchools/data/privateschools1617.xls") %>% 
  read_xls(
    # The skip argument tells R not to read in the first three rows
    skip = 3
    )
```


Now your turn!
* 2 minutes *
Get familiar the priv data frame. Use any functions or techniques you like. (Hint: View(), head(), colnames(), and count() are good places to start!).

What information is there? What structure is the data in?

```{r}
head(priv)
colnames(priv)
```


Wow, that's a lot of columns! Let's just keep the columns we care about.

```{r}
priv2 <- priv %>% 
  # R will let you have spaces in your column names, but the spaces can be a pain to work with. 
  # here we replace any spaces in the column name with an underscore
  rename_all(funs(stringr::str_replace_all(.," ","_"))) %>% 
  # choose just the columns we want to keep
  select(Affidavit_ID,
    County,
    CDS_Code,
    School,
    Public_District,
    # the colon lets us choose all columns between Low Grade and Total Enrollment without having to list them all.
    Kindergarten_Enrollment:Total_Enrollment,
    Religious_Classification,
    Religious_Denomination
  ) 

```


Now, let's explore the data structure a little more. Is there an ID column that's unique for each row?

```{r}
priv2 %>% nrow() 
priv2 %>% select(Affidavit_ID) %>% n_distinct() 
priv2 %>% select(CDS_Code) %>% n_distinct() 
```

What values does the Religious classificaiton and denomination columns have?

```{r}
priv2 %>% count(Religious_Classification)
priv2 %>% count(Religious_Classification,Religious_Denomination)
```


# Read in and explore public school data

This file is tab separated. We'll use the read_tsv function from the readr package.

```{r}
pub <- here("privateSchools/data/enr16.txt") %>% 
  read_tsv(
    # we can specify how R should read in columns (numeric, character, date, etc.)
    # here, we specify the CDS_CODE column should be read in as character. 
    # all other columns that we don't specify have their type auto detected.
    col_types = cols(CDS_CODE = col_character())
    )
```


Your turn! 
* 8 minutes *
Explore the pub dataset. You'll want to know the following:
  - how many rows and columns are there?
  - what are the column names?
  - what is the structure of the data? what column or combination of columns uniquely identifies a row?
  - what values are there for GENDER and ETHNIC? 

```{r}
dim(pub)
colnames(pub)
pub %>% nrow()
pub %>% select(CDS_CODE,GENDER,ETHNIC) %>% n_distinct()
pub %>% count(GENDER)
pub %>% count(ETHNIC)
```

The skim() function is also a nice way to get aquainted with your data.

```{r}
library(skimr)
skim(pub)
```



The pub data is in a 'longer' structure than the priv data. Let's summarize the pub data so it has one row per school.
```{r}
pub2 <- pub %>% 
  select(-ETHNIC,-GENDER) %>% 
  group_by(CDS_CODE,COUNTY,DISTRICT,SCHOOL) %>% 
  # this sums all columns, so you don't have to specify each of them
  summarise_all(funs(sum)) %>% 
  # this makes the data easier to work with going forward
  ungroup()

# check to make sure we have the expected number of rows
pub %>% nrow()
pub %>% select(CDS_CODE,ETHNIC,GENDER) %>% n_distinct()
pub2 %>% nrow()
pub2 %>% select(CDS_CODE) %>% n_distinct()
```




# Combine the private and public enrollment data

Are there any schools on both priv and enr? Let's do an inner join on CDS_Code to check.

```{r}
inner_join(priv2,pub,by=c("CDS_Code"="CDS_CODE")) %>% nrow()
```

None. Good.


Let's combine the data.


```{r}
# make column names consistent
priv3 <- priv2 %>%
  rename(
    DISTRICT=Public_District,
    KDGN=Kindergarten_Enrollment,
    GR_1=Grade_1_Enrollment,
    GR_2=Grade_2_Enrollment,
    GR_3=Grade_3_Enrollment,
    GR_4=Grade_4_Enrollment,
    GR_5=Grade_5_Enrollment,
    GR_6=Grade_6_Enrollment,
    GR_7=Grade_7_Enrollment,
    GR_8=Grade_8_Enrollment,
    UNGR_ELM=Ungraded_Elementary_Enrollmnet,
    GR_9=Grade_9_Enrollment,
    GR_10=Grade_10_Enrollment,
    GR_11=Grade_11_Enrollment,
    GR_12=Grade_12_Enrollment,
    UNGR_SEC=Ungraded_Secondary_Enrollment,
    ENR_TOTAL=Total_Enrollment
  ) %>% 
  rename_all(funs(toupper(.))) 


# combine public and private schools
# we are concatinating the data, not joining it.
schools <- bind_rows(
  pub2  %>% mutate(type="public"),
  priv3 %>% mutate(type="private")
  )

schools %>% count(type)

```


# Restructure data

Let's make our data 'longer'. Now we want one row per school per grade.

```{r}
schools_long <- schools %>% 
  gather(
    key="grade",
    value="enrollment", 
    -CDS_CODE,-COUNTY,-DISTRICT,-SCHOOL,-type,-AFFIDAVIT_ID,-RELIGIOUS_CLASSIFICATION,-RELIGIOUS_DENOMINATION
    ) 

```


Your turn!
* 3 minutes *
What values does the grade column have? Is there anything you would change about it?

```{r}
schools_long %>% count(grade)
```


Let's clean up the grade column.
```{r}
# First, make some changes to the actual words
schools_long <- schools_long %>% 
  mutate(
    grade_clean = case_when(
      # manually recode grade descriptions here
      grade=="ENR_TOTAL"~"TOTAL",
      # then clean up the rest with this formula to remove GR_ 
      TRUE~str_replace(grade,"^GR_","")
    )
  )

schools_long %>% count(grade_clean,grade)

# Second, let's store it as a factor, not character
library(forcats)
orderedGrades <- c("KDGN","1","2","3","4","5","6","7","8","UNGR_ELM","9","10","11","12","UNGR_SEC","ADULT","TOTAL")
schools_long <- schools_long %>% 
  mutate(
    grade_clean = as_factor(grade_clean,levels=orderedGrades)
  )

schools_long %>% count(grade_clean,grade)

```


# Summarize to county level

Your turn!
* 5 minutes *
Can you create a new data frame called county that has one row per county and columns describing:
 - the total number of students enrolled in public and private schools
 - number of students enrolled in private schools
 - percent of students enrolled in private schools

(Hint! remember there's already a grade called 'total'.)

```{r}
county <- schools_long %>% 
  filter(grade_clean=="TOTAL") %>% 
  group_by(COUNTY) %>% 
  summarize(
    tot_enr=sum(enrollment),
    priv_enr=sum((type=="private")*enrollment),
    priv_pct=priv_enr/tot_enr
    )
```


# Make a plot

Your turn!
* 10 minutes *

Make a plot that looks like this:
(/privateSchools/pct_private_by_county.jpg)

```{r}
plot <- county %>% 
  filter(is.na(COUNTY)==F) %>% 
  ggplot(aes(x=reorder(COUNTY,priv_pct),y=priv_pct)) +
    geom_col(position="dodge") +
    theme_minimal() +
    scale_y_continuous(
      labels=scales::percent_format(accuracy=1),
      name="Students in private school"
      ) +
    scale_x_discrete(name=NULL) +
    coord_flip()

plot

# ggsave(plot,file="privateSchools/pct_private_by_county.jpg")
```


